<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›´æ äº‹ä»¶è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        .step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
        }
        .step-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å›´æ äº‹ä»¶è°ƒè¯•å·¥å…·</h1>
        
        <div class="info">
            <strong>è°ƒè¯•è¯´æ˜ï¼š</strong><br>
            æ­¤å·¥å…·å¸®åŠ©æ‚¨é€æ­¥æ’æŸ¥å›´æ äº‹ä»¶ä¸è§¦å‘çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š<br>
            1. GPSæ•°æ®æ¥æ”¶éªŒè¯<br>
            2. è®¾å¤‡ç»‘å®šå…³ç³»æ£€æŸ¥<br>
            3. å›´æ é…ç½®éªŒè¯<br>
            4. äº‹ä»¶è§¦å‘æµ‹è¯•<br>
            5. å®Œæ•´æµç¨‹æ¨¡æ‹Ÿ
        </div>

        <div class="flex-container">
            <div class="flex-item">
                <div class="debug-section">
                    <h2>æ­¥éª¤1: æ£€æŸ¥è®¾å¤‡ç»‘å®š</h2>
                    <div class="form-group">
                        <label for="checkMacid">è®¾å¤‡MACåœ°å€:</label>
                        <input type="text" id="checkMacid" placeholder="è¾“å…¥è¦æ£€æŸ¥çš„MACåœ°å€">
                    </div>
                    <button onclick="checkDeviceBinding()">æ£€æŸ¥è®¾å¤‡ç»‘å®š</button>
                    <button onclick="getAllBindings()">æŸ¥çœ‹æ‰€æœ‰ç»‘å®š</button>
                    <div id="bindingResult"></div>
                </div>

                <div class="debug-section">
                    <h2>æ­¥éª¤2: æ£€æŸ¥å›´æ é…ç½®</h2>
                    <div class="form-group">
                        <label for="checkElderlyId">è€äººID:</label>
                        <input type="number" id="checkElderlyId" placeholder="è¾“å…¥è€äººID">
                    </div>
                    <button onclick="checkFenceConfig()">æ£€æŸ¥å›´æ é…ç½®</button>
                    <div id="fenceResult"></div>
                </div>

                <div class="debug-section">
                    <h2>æ­¥éª¤3: æ¨¡æ‹ŸGPSæ•°æ®æ¨é€</h2>
                    <div class="form-group">
                        <label for="testMacid">è®¾å¤‡MACåœ°å€:</label>
                        <input type="text" id="testMacid" placeholder="è¾“å…¥è®¾å¤‡MACåœ°å€">
                    </div>
                    <div class="form-group">
                        <label for="testLat">çº¬åº¦:</label>
                        <input type="number" id="testLat" step="0.000001" placeholder="ä¾‹å¦‚: 30.572269">
                    </div>
                    <div class="form-group">
                        <label for="testLon">ç»åº¦:</label>
                        <input type="number" id="testLon" step="0.000001" placeholder="ä¾‹å¦‚: 104.066541">
                    </div>
                    <button onclick="sendTestGpsData()">å‘é€æµ‹è¯•GPSæ•°æ®</button>
                    <div id="gpsResult"></div>
                </div>
            </div>

            <div class="flex-item">
                <div class="debug-section">
                    <h2>æ­¥éª¤4: æ£€æŸ¥å›´æ äº‹ä»¶</h2>
                    <div class="form-group">
                        <label for="eventElderlyId">è€äººID:</label>
                        <input type="number" id="eventElderlyId" placeholder="è¾“å…¥è€äººID">
                    </div>
                    <button onclick="checkRecentEvents()">æŸ¥çœ‹æœ€è¿‘äº‹ä»¶</button>
                    <button onclick="checkUnreadEvents()">æŸ¥çœ‹æœªè¯»äº‹ä»¶</button>
                    <div id="eventResult"></div>
                </div>

                <div class="debug-section">
                    <h2>æ­¥éª¤5: å®Œæ•´æµç¨‹æµ‹è¯•</h2>
                    <div class="warning">
                        <strong>æ³¨æ„ï¼š</strong>è¯·ç¡®ä¿å·²å®Œæˆè®¾å¤‡ç»‘å®šå’Œå›´æ é…ç½®åå†è¿›è¡Œæ­¤æµ‹è¯•
                    </div>
                    <div class="form-group">
                        <label for="fullTestMacid">è®¾å¤‡MACåœ°å€:</label>
                        <input type="text" id="fullTestMacid" placeholder="è¾“å…¥å·²ç»‘å®šçš„è®¾å¤‡MACåœ°å€">
                    </div>
                    <div class="form-group">
                        <label for="fullTestLat">å›´æ å¤–çº¬åº¦:</label>
                        <input type="number" id="fullTestLat" step="0.000001" placeholder="è¾“å…¥å›´æ å¤–çš„çº¬åº¦">
                    </div>
                    <div class="form-group">
                        <label for="fullTestLon">å›´æ å¤–ç»åº¦:</label>
                        <input type="number" id="fullTestLon" step="0.000001" placeholder="è¾“å…¥å›´æ å¤–çš„ç»åº¦">
                    </div>
                    <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                    <div id="fullTestResult"></div>
                </div>

                <div class="debug-section">
                    <h2>è°ƒè¯•æ—¥å¿—</h2>
                    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                    <div id="debugLog" class="log"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // æ£€æŸ¥è®¾å¤‡ç»‘å®š
        async function checkDeviceBinding() {
            const macid = document.getElementById('checkMacid').value.trim();
            if (!macid) {
                showResult('bindingResult', 'è¯·è¾“å…¥è®¾å¤‡MACåœ°å€', 'error');
                return;
            }

            log(`æ£€æŸ¥è®¾å¤‡ç»‘å®š: ${macid}`);
            try {
                const response = await fetch(`${API_BASE}/gps/bindings`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const binding = result.data.find(b => b.macid === macid);
                        if (binding) {
                            showResult('bindingResult', 
                                `âœ… è®¾å¤‡å·²ç»‘å®š<br>` +
                                `MACåœ°å€: ${binding.macid}<br>` +
                                `è€äººID: ${binding.elderly_id}<br>` +
                                `è€äººå§“å: ${binding.elderly_name || 'æœªçŸ¥'}<br>` +
                                `ç»‘å®šæ—¶é—´: ${binding.bind_time}<br>` +
                                `çŠ¶æ€: ${binding.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 
                                'success');
                            log(`è®¾å¤‡ç»‘å®šæ£€æŸ¥æˆåŠŸ: ${macid} -> è€äººID: ${binding.elderly_id}`);
                        } else {
                            showResult('bindingResult', `âŒ è®¾å¤‡æœªç»‘å®š: ${macid}`, 'error');
                            log(`è®¾å¤‡æœªç»‘å®š: ${macid}`, 'error');
                        }
                    } else {
                        showResult('bindingResult', 'è·å–ç»‘å®šåˆ—è¡¨å¤±è´¥', 'error');
                        log('è·å–ç»‘å®šåˆ—è¡¨å¤±è´¥', 'error');
                    }
                } else {
                    showResult('bindingResult', `APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'error');
                    log(`è·å–ç»‘å®šåˆ—è¡¨APIå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('bindingResult', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`æ£€æŸ¥è®¾å¤‡ç»‘å®šå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–æ‰€æœ‰ç»‘å®š
        async function getAllBindings() {
            log('è·å–æ‰€æœ‰è®¾å¤‡ç»‘å®š');
            try {
                const response = await fetch(`${API_BASE}/gps/bindings`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        let bindingHtml = `<h4>æ‰€æœ‰è®¾å¤‡ç»‘å®š (${result.data.length}ä¸ª):</h4>`;
                        if (result.data.length === 0) {
                            bindingHtml += '<p>æš‚æ— è®¾å¤‡ç»‘å®š</p>';
                        } else {
                            bindingHtml += '<div class="json-display">';
                            result.data.forEach(binding => {
                                bindingHtml += `MAC: ${binding.macid} -> è€äººID: ${binding.elderly_id} (${binding.elderly_name || 'æœªçŸ¥'})\n`;
                            });
                            bindingHtml += '</div>';
                        }
                        showResult('bindingResult', bindingHtml, 'info');
                        log(`è·å–åˆ° ${result.data.length} ä¸ªè®¾å¤‡ç»‘å®š`);
                    } else {
                        showResult('bindingResult', 'è·å–ç»‘å®šåˆ—è¡¨å¤±è´¥', 'error');
                        log('è·å–ç»‘å®šåˆ—è¡¨å¤±è´¥', 'error');
                    }
                } else {
                    showResult('bindingResult', `APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'error');
                    log(`è·å–ç»‘å®šåˆ—è¡¨APIå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('bindingResult', `è·å–å¤±è´¥: ${error.message}`, 'error');
                log(`è·å–æ‰€æœ‰ç»‘å®šå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥å›´æ é…ç½®
        async function checkFenceConfig() {
            const elderlyId = document.getElementById('checkElderlyId').value.trim();
            if (!elderlyId) {
                showResult('fenceResult', 'è¯·è¾“å…¥è€äººID', 'error');
                return;
            }

            log(`æ£€æŸ¥å›´æ é…ç½®: è€äººID ${elderlyId}`);
            try {
                const response = await fetch(`${API_BASE}/geo-fence/list?elderlyId=${elderlyId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const activeFences = result.data.filter(f => f.status === 1);
                        let fenceHtml = `<h4>å›´æ é…ç½® (${activeFences.length}ä¸ªå¯ç”¨):</h4>`;
                        if (activeFences.length === 0) {
                            fenceHtml += '<p class="warning">âŒ è¯¥è€äººæ²¡æœ‰å¯ç”¨çš„å›´æ ï¼Œæ— æ³•è§¦å‘å›´æ äº‹ä»¶</p>';
                        } else {
                            activeFences.forEach(fence => {
                                fenceHtml += `<div class="step">`;
                                fenceHtml += `<div class="step-title">å›´æ : ${fence.fence_name}</div>`;
                                fenceHtml += `ID: ${fence.id}<br>`;
                                fenceHtml += `ç±»å‹: ${fence.fence_type}<br>`;
                                fenceHtml += `è¿›å…¥å‘Šè­¦: ${fence.enter_alert === 1 ? 'âœ…å¯ç”¨' : 'âŒç¦ç”¨'}<br>`;
                                fenceHtml += `ç¦»å¼€å‘Šè­¦: ${fence.exit_alert === 1 ? 'âœ…å¯ç”¨' : 'âŒç¦ç”¨'}<br>`;
                                if (fence.fence_type === 'circle') {
                                    fenceHtml += `ä¸­å¿ƒç‚¹: (${fence.center_lat}, ${fence.center_lon})<br>`;
                                    fenceHtml += `åŠå¾„: ${fence.radius}ç±³<br>`;
                                }
                                fenceHtml += `</div>`;
                            });
                        }
                        showResult('fenceResult', fenceHtml, activeFences.length > 0 ? 'success' : 'warning');
                        log(`å›´æ é…ç½®æ£€æŸ¥å®Œæˆ: æ‰¾åˆ° ${activeFences.length} ä¸ªå¯ç”¨çš„å›´æ `);
                    } else {
                        showResult('fenceResult', 'è·å–å›´æ åˆ—è¡¨å¤±è´¥', 'error');
                        log('è·å–å›´æ åˆ—è¡¨å¤±è´¥', 'error');
                    }
                } else {
                    showResult('fenceResult', `APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'error');
                    log(`è·å–å›´æ åˆ—è¡¨APIå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('fenceResult', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`æ£€æŸ¥å›´æ é…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‘é€æµ‹è¯•GPSæ•°æ®
        async function sendTestGpsData() {
            const macid = document.getElementById('testMacid').value.trim();
            const lat = document.getElementById('testLat').value.trim();
            const lon = document.getElementById('testLon').value.trim();
            
            if (!macid || !lat || !lon) {
                showResult('gpsResult', 'è¯·å¡«å†™å®Œæ•´çš„GPSæ•°æ®', 'error');
                return;
            }

            log(`å‘é€æµ‹è¯•GPSæ•°æ®: MAC=${macid}, ä½ç½®=(${lat}, ${lon})`);
            
            // æ„é€ GPSæ•°æ®
            const gpsData = [{
                macid: macid,
                gpsTime: new Date().toISOString(),
                heartTime: new Date().toISOString(),
                updTime: new Date().toISOString(),
                lat: lat,
                lon: lon,
                mapLat: lat,
                mapLon: lon,
                speed: "0",
                dir: "0",
                stats: "A",
                value: "1"
            }];

            try {
                const formData = new FormData();
                formData.append('method', 'status');
                formData.append('serialNumber', Date.now().toString());
                formData.append('data', JSON.stringify(gpsData));

                const response = await fetch(`${API_BASE}/gps/push`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.text();
                    showResult('gpsResult', 
                        `âœ… GPSæ•°æ®å‘é€æˆåŠŸ<br>` +
                        `è¿”å›ç»“æœ: ${result}<br>` +
                        `<div class="json-display">å‘é€çš„æ•°æ®:\n${JSON.stringify(gpsData, null, 2)}</div>`, 
                        'success');
                    log(`GPSæ•°æ®å‘é€æˆåŠŸ: ${result}`);
                } else {
                    const errorText = await response.text();
                    showResult('gpsResult', `âŒ GPSæ•°æ®å‘é€å¤±è´¥: ${response.status}<br>${errorText}`, 'error');
                    log(`GPSæ•°æ®å‘é€å¤±è´¥: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                showResult('gpsResult', `âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
                log(`å‘é€GPSæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥æœ€è¿‘äº‹ä»¶
        async function checkRecentEvents() {
            const elderlyId = document.getElementById('eventElderlyId').value.trim();
            
            log(`æ£€æŸ¥æœ€è¿‘å›´æ äº‹ä»¶: è€äººID ${elderlyId || 'å…¨éƒ¨'}`);
            try {
                let url = `${API_BASE}/geo-fence/events/recent?limit=10`;
                if (elderlyId) {
                    url += `&elderlyId=${elderlyId}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        let eventHtml = `<h4>æœ€è¿‘å›´æ äº‹ä»¶ (${result.data.length}ä¸ª):</h4>`;
                        if (result.data.length === 0) {
                            eventHtml += '<p class="warning">æš‚æ— å›´æ äº‹ä»¶è®°å½•</p>';
                        } else {
                            eventHtml += '<div class="json-display">';
                            result.data.forEach(event => {
                                eventHtml += `æ—¶é—´: ${event.event_time}\n`;
                                eventHtml += `è€äºº: ${event.elderly_name} (ID: ${event.elderly_id})\n`;
                                eventHtml += `å›´æ : ${event.fence_name}\n`;
                                eventHtml += `äº‹ä»¶: ${event.event_type === 'enter' ? 'è¿›å…¥' : 'ç¦»å¼€'}\n`;
                                eventHtml += `ä½ç½®: (${event.lat}, ${event.lon})\n`;
                                eventHtml += `å·²è¯»: ${event.is_read === 1 ? 'æ˜¯' : 'å¦'}\n`;
                                eventHtml += `å‘Šè­¦å·²å‘é€: ${event.alert_sent === 1 ? 'æ˜¯' : 'å¦'}\n`;
                                eventHtml += `---\n`;
                            });
                            eventHtml += '</div>';
                        }
                        showResult('eventResult', eventHtml, result.data.length > 0 ? 'success' : 'warning');
                        log(`æ£€æŸ¥åˆ° ${result.data.length} ä¸ªæœ€è¿‘äº‹ä»¶`);
                    } else {
                        showResult('eventResult', 'è·å–äº‹ä»¶åˆ—è¡¨å¤±è´¥', 'error');
                        log('è·å–äº‹ä»¶åˆ—è¡¨å¤±è´¥', 'error');
                    }
                } else {
                    showResult('eventResult', `APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'error');
                    log(`è·å–äº‹ä»¶åˆ—è¡¨APIå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('eventResult', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`æ£€æŸ¥æœ€è¿‘äº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥æœªè¯»äº‹ä»¶
        async function checkUnreadEvents() {
            log('æ£€æŸ¥æœªè¯»å›´æ äº‹ä»¶');
            try {
                const response = await fetch(`${API_BASE}/geo-fence/events/recent?unread=true&limit=10`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        let eventHtml = `<h4>æœªè¯»å›´æ äº‹ä»¶ (${result.data.length}ä¸ª):</h4>`;
                        if (result.data.length === 0) {
                            eventHtml += '<p class="info">æš‚æ— æœªè¯»å›´æ äº‹ä»¶</p>';
                        } else {
                            eventHtml += '<div class="json-display">';
                            result.data.forEach(event => {
                                eventHtml += `æ—¶é—´: ${event.event_time}\n`;
                                eventHtml += `è€äºº: ${event.elderly_name} (ID: ${event.elderly_id})\n`;
                                eventHtml += `å›´æ : ${event.fence_name}\n`;
                                eventHtml += `äº‹ä»¶: ${event.event_type === 'enter' ? 'è¿›å…¥' : 'ç¦»å¼€'}\n`;
                                eventHtml += `ä½ç½®: (${event.lat}, ${event.lon})\n`;
                                eventHtml += `---\n`;
                            });
                            eventHtml += '</div>';
                        }
                        showResult('eventResult', eventHtml, result.data.length > 0 ? 'success' : 'info');
                        log(`æ£€æŸ¥åˆ° ${result.data.length} ä¸ªæœªè¯»äº‹ä»¶`);
                    } else {
                        showResult('eventResult', 'è·å–æœªè¯»äº‹ä»¶åˆ—è¡¨å¤±è´¥', 'error');
                        log('è·å–æœªè¯»äº‹ä»¶åˆ—è¡¨å¤±è´¥', 'error');
                    }
                } else {
                    showResult('eventResult', `APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'error');
                    log(`è·å–æœªè¯»äº‹ä»¶åˆ—è¡¨APIå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('eventResult', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                log(`æ£€æŸ¥æœªè¯»äº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            const macid = document.getElementById('fullTestMacid').value.trim();
            const lat = document.getElementById('fullTestLat').value.trim();
            const lon = document.getElementById('fullTestLon').value.trim();
            
            if (!macid || !lat || !lon) {
                showResult('fullTestResult', 'è¯·å¡«å†™å®Œæ•´çš„æµ‹è¯•æ•°æ®', 'error');
                return;
            }

            log('å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...');
            showResult('fullTestResult', 'æ­£åœ¨æ‰§è¡Œå®Œæ•´æµ‹è¯•ï¼Œè¯·ç¨å€™...', 'info');

            let testResults = [];
            
            try {
                // æ­¥éª¤1: æ£€æŸ¥è®¾å¤‡ç»‘å®š
                log('æ­¥éª¤1: æ£€æŸ¥è®¾å¤‡ç»‘å®š');
                const bindingResponse = await fetch(`${API_BASE}/gps/bindings`);
                if (bindingResponse.ok) {
                    const bindingResult = await bindingResponse.json();
                    const binding = bindingResult.data?.find(b => b.macid === macid);
                    if (binding) {
                        testResults.push(`âœ… æ­¥éª¤1: è®¾å¤‡å·²ç»‘å®š (è€äººID: ${binding.elderly_id})`);
                        log(`è®¾å¤‡ç»‘å®šæ£€æŸ¥é€šè¿‡: ${macid} -> ${binding.elderly_id}`);
                        
                        // æ­¥éª¤2: æ£€æŸ¥å›´æ é…ç½®
                        log('æ­¥éª¤2: æ£€æŸ¥å›´æ é…ç½®');
                        const fenceResponse = await fetch(`${API_BASE}/geo-fence/list?elderlyId=${binding.elderly_id}`);
                        if (fenceResponse.ok) {
                            const fenceResult = await fenceResponse.json();
                            const activeFences = fenceResult.data?.filter(f => f.status === 1 && f.exit_alert === 1) || [];
                            if (activeFences.length > 0) {
                                testResults.push(`âœ… æ­¥éª¤2: æ‰¾åˆ° ${activeFences.length} ä¸ªå¯ç”¨ç¦»å¼€å‘Šè­¦çš„å›´æ `);
                                log(`å›´æ é…ç½®æ£€æŸ¥é€šè¿‡: ${activeFences.length} ä¸ªå›´æ `);
                                
                                // æ­¥éª¤3: å‘é€GPSæ•°æ®
                                log('æ­¥éª¤3: å‘é€GPSæ•°æ®');
                                const gpsData = [{
                                    macid: macid,
                                    gpsTime: new Date().toISOString(),
                                    heartTime: new Date().toISOString(),
                                    updTime: new Date().toISOString(),
                                    lat: lat,
                                    lon: lon,
                                    mapLat: lat,
                                    mapLon: lon,
                                    speed: "0",
                                    dir: "0",
                                    stats: "A",
                                    value: "1"
                                }];
                                
                                const formData = new FormData();
                                formData.append('method', 'status');
                                formData.append('serialNumber', Date.now().toString());
                                formData.append('data', JSON.stringify(gpsData));

                                const gpsResponse = await fetch(`${API_BASE}/gps/push`, {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                if (gpsResponse.ok) {
                                    testResults.push(`âœ… æ­¥éª¤3: GPSæ•°æ®å‘é€æˆåŠŸ`);
                                    log('GPSæ•°æ®å‘é€æˆåŠŸ');
                                    
                                    // æ­¥éª¤4: ç­‰å¾…å¹¶æ£€æŸ¥äº‹ä»¶
                                    log('æ­¥éª¤4: ç­‰å¾…3ç§’åæ£€æŸ¥äº‹ä»¶');
                                    testResults.push(`â³ æ­¥éª¤4: ç­‰å¾…3ç§’åæ£€æŸ¥å›´æ äº‹ä»¶...`);
                                    
                                    setTimeout(async () => {
                                        try {
                                            const eventResponse = await fetch(`${API_BASE}/geo-fence/events/recent?elderlyId=${binding.elderly_id}&limit=5`);
                                            if (eventResponse.ok) {
                                                const eventResult = await eventResponse.json();
                                                const recentEvents = eventResult.data || [];
                                                const newEvents = recentEvents.filter(e => {
                                                    const eventTime = new Date(e.event_time);
                                                    const now = new Date();
                                                    return (now - eventTime) < 60000; // 1åˆ†é’Ÿå†…çš„äº‹ä»¶
                                                });
                                                
                                                if (newEvents.length > 0) {
                                                    testResults.push(`âœ… æ­¥éª¤4: æˆåŠŸè§¦å‘ ${newEvents.length} ä¸ªå›´æ äº‹ä»¶`);
                                                    newEvents.forEach(event => {
                                                        testResults.push(`   - ${event.event_type === 'enter' ? 'è¿›å…¥' : 'ç¦»å¼€'} ${event.fence_name}`);
                                                    });
                                                    log(`å›´æ äº‹ä»¶è§¦å‘æˆåŠŸ: ${newEvents.length} ä¸ªäº‹ä»¶`);
                                                } else {
                                                    testResults.push(`âŒ æ­¥éª¤4: æœªæ£€æµ‹åˆ°æ–°çš„å›´æ äº‹ä»¶`);
                                                    testResults.push(`   å¯èƒ½åŸå› : ä½ç½®åœ¨å›´æ å†…ï¼Œæˆ–å›´æ é…ç½®æœ‰è¯¯`);
                                                    log('æœªæ£€æµ‹åˆ°æ–°çš„å›´æ äº‹ä»¶', 'warning');
                                                }
                                            } else {
                                                testResults.push(`âŒ æ­¥éª¤4: æ£€æŸ¥äº‹ä»¶å¤±è´¥`);
                                                log('æ£€æŸ¥äº‹ä»¶APIå¤±è´¥', 'error');
                                            }
                                        } catch (error) {
                                            testResults.push(`âŒ æ­¥éª¤4: æ£€æŸ¥äº‹ä»¶å¼‚å¸¸: ${error.message}`);
                                            log(`æ£€æŸ¥äº‹ä»¶å¼‚å¸¸: ${error.message}`, 'error');
                                        }
                                        
                                        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                                        const finalResult = testResults.join('<br>');
                                        showResult('fullTestResult', finalResult, 'info');
                                        log('å®Œæ•´æµ‹è¯•æµç¨‹ç»“æŸ');
                                    }, 3000);
                                    
                                } else {
                                    testResults.push(`âŒ æ­¥éª¤3: GPSæ•°æ®å‘é€å¤±è´¥`);
                                    log('GPSæ•°æ®å‘é€å¤±è´¥', 'error');
                                }
                            } else {
                                testResults.push(`âŒ æ­¥éª¤2: è¯¥è€äººæ²¡æœ‰å¯ç”¨ç¦»å¼€å‘Šè­¦çš„å›´æ `);
                                log('æ²¡æœ‰å¯ç”¨ç¦»å¼€å‘Šè­¦çš„å›´æ ', 'error');
                            }
                        } else {
                            testResults.push(`âŒ æ­¥éª¤2: è·å–å›´æ é…ç½®å¤±è´¥`);
                            log('è·å–å›´æ é…ç½®å¤±è´¥', 'error');
                        }
                    } else {
                        testResults.push(`âŒ æ­¥éª¤1: è®¾å¤‡æœªç»‘å®š`);
                        log('è®¾å¤‡æœªç»‘å®š', 'error');
                    }
                } else {
                    testResults.push(`âŒ æ­¥éª¤1: è·å–è®¾å¤‡ç»‘å®šå¤±è´¥`);
                    log('è·å–è®¾å¤‡ç»‘å®šå¤±è´¥', 'error');
                }
                
                // å¦‚æœå‰é¢çš„æ­¥éª¤å¤±è´¥ï¼Œæ˜¾ç¤ºå½“å‰ç»“æœ
                if (testResults[testResults.length - 1].startsWith('âŒ')) {
                    const currentResult = testResults.join('<br>');
                    showResult('fullTestResult', currentResult, 'error');
                }
                
            } catch (error) {
                testResults.push(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`);
                const finalResult = testResults.join('<br>');
                showResult('fullTestResult', finalResult, 'error');
                log(`å®Œæ•´æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('å›´æ äº‹ä»¶è°ƒè¯•å·¥å…·å·²åŠ è½½');
        };
    </script>
</body>
</html>